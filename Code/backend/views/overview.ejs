<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="./stylesheets/overview.css" />
  </head>
  <body>
    <!-- TEMPLATE -->
    <!-- <template id="userTemplate">
      <tr>
        <td class="currentURL"></td>
        <td class="refferURL"></td>
        <td class="timestamp"></td>
        <td class="utm_m"></td>
        <td class="utm_s"></td>
        <td class="utm_camp"></td>
        <td class="utm_term"></td>
        <td class="utm_cont"></td>
        <td class="userAgent"></td>
        <td class="lsn"></td>
        <td class="visit"></td>
        <td class="platform"></td>
        <td class="country"></td>
      </tr>
    </template> -->
    <!-- END TEMPLATE -->
    <header>
      <h1>Analytics</h1>
      <div>
        <p>USEREMAIL</p>
        <a href="#">Logout</a>
      </div>
    </header>
    <div id="wrapper">
      <div id="sideMenu">
        <div>
          <a href="/overview"><b>Overview</b></a>
          <a href="#">Locations</a>
          <a href="#">Trafix Sources</a>
        </div>
      </div>
      <div>
        <h1 style="margin-left: 20px; margin-top: 10px; font-size: large">
          Overview
        </h1>
        <div style="display: flex; margin-top: 20px">
          <div id="counter">
            <p>Right now</p>
            <p style="font-size: 4rem"><%= data.views %></p>
            <p style="font-size: small">active visitors on the site</p>

            <div class="progress-bar">
              <div class="bar" id="dynamic-bar"></div>
            </div>
          </div>
        </div>
        <div style="display: flex">asdf</div>
         <div id="list">
        <table>
          <thead>
            <tr>
              <th>Current url</th>
              <th>Reffer url</th>
              <th>Timestamp</th>
              <th>Utm medium</th>
              <th>Utm source</th>
              <th>Utm campaign</th>
              <th>Utm term</th>
              <th>Utm content</th>
              <th>User agent</th>
              <th>Lead source name</th>
              <th>First visit</th>
              <th>Platform</th>
              <th>Country</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      </div>
    </div>
  </body>
  <script>
    // Connect to socket
    const socket = new WebSocket("ws://localhost:8082", "dashboard");
    // Add message
    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);

        // Set count of users, regardless of the type of the message
        updateUserCount(data.currentCount);

        if (
          data.msg &&
          data.msg.type !== undefined &&
          data.msg.type === "clientJoin"
        ) {
          addUser(
            data.msg.currentURL,
            data.msg.referrerURL,
            data.msg.timestamp,
            data.msg.utmMedium,
            data.msg.utmSource,
            data.msg.utmCamp,
            data.msg.utmTerm,
            data.msg.utmContent,
            data.msg.userAgent,
            data.msg.leadSourceName,
            data.msg.isFirstVisit,
            data.msg.platform,
            data.msg.country
          );
          console.log(data.msg.country);
        }
      } catch (error) {
        console.error("Error processing message:", error);
      }
    };
    // Updates the DOM
    function updateUserCount(newCount) {
      const userCountElement = document.getElementById("userCount");
      userCountElement.innerText = newCount || "no data";
    }

    // Updates the DOM and refreshes the list in real-time
    function addUser(
      currentURL,
      referrerURL,
      timestamp,
      utmMedium,
      utmSource,
      utmCamp,
      utmTerm,
      utmCont,
      userAgent,
      leadSourceName,
      isFirstVisit,
      platformz,
      country
    ) {
      const rowTemplate = document.getElementById("userTemplate").content;
      const tableBody = document.getElementById("tableBody");
      // Clone and update the DOM
      const newRow = document.importNode(rowTemplate, true);
      newRow.querySelector(".currentURL").textContent = currentURL;
      newRow.querySelector(".refferURL").textContent = referrerURL;
      newRow.querySelector(".timestamp").textContent = timestamp;
      newRow.querySelector(".utm_m").textContent = utmMedium || "null";
      newRow.querySelector(".utm_s").textContent = utmSource || "null";
      newRow.querySelector(".utm_camp").textContent = utmCamp || "null";
      newRow.querySelector(".utm_term").textContent = utmTerm || "null";
      newRow.querySelector(".utm_cont").textContent = utmCont || "null";
      newRow.querySelector(".userAgent").textContent = userAgent;
      newRow.querySelector(".lsn").textContent = leadSourceName || "null";
      newRow.querySelector(".visit").textContent = isFirstVisit;
      newRow.querySelector(".platform").textContent = platformz || "null";
      newRow.querySelector(".country").textContent = country;

      // Add to the DOM
      tableBody.insertBefore(newRow, tableBody.firstChild);
    }

    const dynamicBar = document.getElementById("dynamic-bar");
    const occupancyPercentage = 75; // Change this value as needed
    const freePercentage = 100 - occupancyPercentage;
    dynamicBar.style.width = `${occupancyPercentage}%`;
    dynamicBar.style.backgroundColor = "#3498db"; // Blue for occupied
    dynamicBar.style.borderRight = `${freePercentage}% solid #2ecc71`; // Green for free
  </script>
</html>
